<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>é£²æ°´æ©Ÿç‡Ÿé‹åœ°åœ–</title>

    <link rel="stylesheet" href="css/bootstrap.min.css" />
    <link rel="stylesheet" href="css/table-rwd.css" />
    <link rel="stylesheet" href="css/all.min.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <link rel="stylesheet" href="css/MarkerCluster.css" />
    <link rel="stylesheet" href="css/my.css" />

    <style>
        .list-group {
            height: 85vh;
            overflow: scroll;
        }

        .marker-cluster-small {
            background-color: rgba(181, 226, 140, 0.6);
        }

        .marker-cluster-small div {
            background-color: rgba(110, 204, 57, 0.6);
        }

        .marker-cluster-medium {
            background-color: rgba(241, 210, 87, 0.6);
        }

        .marker-cluster-medium div {
            background-color: rgba(240, 194, 12, 0.6);
        }

        .marker-cluster div {
            width: 30px;
            height: 30px;
            margin-left: 5px;
            margin-right: 5px;
            text-align: center;
            border-radius: 15px;
        }

        .marker-cluster span {
            line-height: 30px;
        }

        /* å°å°åŠ ç¢¼ï¼šä¸»ç®¡ä¸€çœ¼æ‡‚ï¼ˆä¸é é¡è‰²ä¹Ÿçœ‹å¾—æ‡‚ï¼‰ */
        .badge-risk {
            font-size: 2rem;
        }

        /* === Device Icons (Leaflet divIcon) === */
        .device-icon {
            position: relative;
            width: 28px;
            height: 28px;
            border: 2px solid rgba(0, 0, 0, .35);
            display: grid;
            place-items: center;
            font-weight: 900;
            color: #111;
            box-shadow: 0 2px 6px rgba(0, 0, 0, .25);
            user-select: none;
        }

        .device-icon .main {
            font-size: 14px;
            line-height: 1;
        }

        /* é¢¨éšªå½¢ç‹€ */
        .device-green {
            background: #2ecc71;
            border-radius: 10px;
        }

        .device-yellow {
            background: #f1c40f;
            transform: rotate(45deg);
            border-radius: 6px;
        }

        .device-yellow .main {
            transform: rotate(-45deg);
            /* æŠŠå­—è½‰å›ä¾† */
        }

        .device-red {
            background: #e74c3c;
            border-radius: 50%;
        }

        /* å ±ä¿®è§’æ¨™ */
        .device-icon .badge-tool {
            position: absolute;
            top: -6px;
            right: -6px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #0d6efd;
            color: white;
            display: grid;
            place-items: center;
            font-size: 11px;
            border: 2px solid white;
        }

        /* é›¢ç·šæ–œç·š */
        .device-icon.offline::after {
            content: "";
            position: absolute;
            width: 34px;
            height: 2px;
            background: rgba(0, 0, 0, .55);
            transform: rotate(-35deg);
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <div class="row vh-100">
            <div class="col-md-4 bg-03">
                <select id="cityOption" class="form-select form-select-lg mt-3">
                    <option value="" selected disabled class="fw-900">--- è«‹å…ˆé¸æ“‡ç¸£å¸‚åç¨± ---</option>
                    <option value="è‡ºä¸­å¸‚">è‡ºä¸­å¸‚</option>
                    <option value="è‡ºåŒ—å¸‚">è‡ºåŒ—å¸‚</option>
                </select>

                <select id="areaOption" class="form-select form-select-lg mt-3" disabled>
                    <option value="" selected disabled class="fw-900">--- é¸æ“‡é„‰é®å€åç¨± ---</option>
                    <option value="è¥¿å±¯å€">è¥¿å±¯å€</option>
                    <option value="å—å±¯å€">å—å±¯å€</option>
                    <option value="æ¾å±±å€">æ¾å±±å€</option>
                </select>

                <ul class="list-group mt-3">
                    <li class="list-group-item">
                        <div class="h4 fw-900">è¨­å‚™åç¨±</div>
                        <div class="h4 fw-900">å®¢æˆ¶: XXXXX</div>
                        <div class="h4 fw-900">åœ°å€: XXXXXX</div>
                        <div class="h4 fw-900 mb-0">è¯çµ¡é›»è©±: XXXXXXX</div>
                        <div class="h4 fw-900 mb-0">é¢¨éšª: <span class="badge bg-success badge-risk">GREEN</span></div>
                        <div class="h4 fw-900">ä¸‹æ¬¡ä¿é¤Šåˆ°æœŸ: 2026/01/12</div>
                    </li>
                </ul>
            </div>

            <div class="col-md-8 bg-02 p-0">
                <div id="map" class="w-100 h-100"></div>
            </div>
        </div>
    </div>

    <script src="js/bootstrap.bundle.min.js"></script>
    <script src="js/jquery-3.7.1.js"></script>
    <script src="https://unpkg.com/axios@1.6.7/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="js/leaflet.markercluster.js"></script>

    <script>
        let map;                 // åœ°åœ–
        let markerMap = {};      // marker ç´¢å¼•ï¼šç”¨ã€Œè¨­å‚™ idã€ç•¶ keyï¼ˆç©©ï¼‰
        let markersCluster;      // ç¾¤èš

        let cityData;            // ç¸£å¸‚è³‡æ–™
        let deviceData;          // é£²æ°´æ©Ÿè³‡æ–™ï¼ˆFeatureCollectionï¼‰
        let selectedCity;        // é¸åˆ°çš„ç¸£å¸‚
        let selectedArea;        // é¸åˆ°çš„é„‰é®å€

        $(async function () {
            initMap();

            // ç¸£å¸‚/é„‰é®å€é¸å–®è³‡æ–™ï¼ˆä½ å¯ä»¥æ²¿ç”¨ CityCountyData.jsonï¼‰
            cityData = await getCityData();

            // é£²æ°´æ©Ÿè³‡æ–™ï¼ˆè«‹æŠŠæª”æ¡ˆå­˜æˆ js/json/water_points.jsonï¼‰
            deviceData = await getDeviceData();

            renderCityOption(cityData);

            // ç¸£å¸‚ change
            $("#cityOption").on("change", function () {
                selectedCity = $(this).val();

                // æ“ä½œå“¡è§’åº¦ï¼šæ›ç¸£å¸‚å°±æ¸…ä¹¾æ·¨ï¼Œé¿å…èª¤åˆ¤
                $("#areaOption").prop("disabled", false);
                $("#areaOption").val("");
                $(".list-group").empty().append(`
          <li class="list-group-item">
            <div class="h4 fw-900 text-muted">è«‹é¸æ“‡é„‰é®å€ä»¥æŸ¥çœ‹è¨­å‚™</div>
          </li>
        `);
                removeMarker();

                cityData.forEach((item) => {
                    if (item.CityName == selectedCity) {
                        renderAreaOption(item.AreaList);
                    }
                });
            });

            // é„‰é®å€ change
            $("#areaOption").on("change", function () {
                selectedArea = $(this).val();

                // ç”¨ city / area ä¾†éæ¿¾ï¼ˆå°æ‡‰ä½ é£²æ°´æ©Ÿè³‡æ–™çš„ properties.city / properties.areaï¼‰
                let filterData = deviceData.features.filter(item => {
                    return item.properties.city == selectedCity && item.properties.area == selectedArea;
                });

                // æ“ä½œå“¡ï¼šå…ˆæŠŠç´…çš„æ”¾å‰é¢ï¼Œå†é»ƒï¼Œå†ç¶ ï¼ˆå…ˆæ•‘ç«ï¼‰
                filterData.sort((a, b) => riskRank(b.properties.risk_level) - riskRank(a.properties.risk_level));

                renderDeviceList(filterData);
                removeMarker();
                renderMarkers(filterData);
            });

            // é»å·¦å´åˆ—è¡¨ â†’ è·³åˆ° marker
            $(document).on("click", ".device-item", function () {
                const id = $(this).data("id");          // ç”¨è¨­å‚™ id
                const marker = markerMap[id];
                if (!marker) return;

                markersCluster.zoomToShowLayer(marker, function () {
                    map.panTo(marker.getLatLng());
                    marker.openPopup();
                });
            });
        });

        // åœ°åœ–åˆå§‹åŒ–
        function initMap() {
            map = L.map('map').setView([24.171425, 120.609670], 13);

            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            L.marker([24.171425, 120.609670]).addTo(map)
                .bindPopup('ç‡Ÿé‹ä¸­å¿ƒ')
                .openPopup();

            markersCluster = new L.markerClusterGroup().addTo(map);
        }

        // å–å¾—ç¸£å¸‚è³‡æ–™
        function getCityData() {
            return $.ajax({
                type: "GET",
                url: "js/json/CityCountyData.json",
                dataType: "json"
            });
        }

        // å–å¾—é£²æ°´æ©Ÿè³‡æ–™
        function getDeviceData() {
            return $.ajax({
                type: "GET",
                url: "js/json/water_points.json",
                dataType: "json"
            });
        }

        // ç”¢ç”Ÿç¸£å¸‚é¸å–®
        function renderCityOption(data) {
            $("#cityOption").empty();
            $("#cityOption").append(`<option value="" selected disabled class="fw-900">--- è«‹å…ˆé¸æ“‡ç¸£å¸‚åç¨± ---</option>`);
            data.forEach((item) => {
                $("#cityOption").append(`<option value="${item.CityName}">${item.CityName}</option>`);
            });
        }

        // ç”¢ç”Ÿé„‰é®å€é¸å–®
        function renderAreaOption(data) {
            $("#areaOption").empty();
            $("#areaOption").append(`<option value="" selected disabled class="fw-900">--- é¸æ“‡é„‰é®å€åç¨± ---</option>`);
            data.forEach((item) => {
                $("#areaOption").append(`<option value="${item.AreaName}">${item.AreaName}</option>`);
            });
        }

        // é¢¨éšªç­‰ç´šæ’åºç”¨
        function riskRank(level) {
            switch ((level || "").toUpperCase()) {
                case "RED": return 3;
                case "YELLOW": return 2;
                case "GREEN": return 1;
                default: return 0;
            }
        }

        function riskBadge(level) {
            const lv = (level || "").toUpperCase();
            if (lv === "RED") return `<span class="badge bg-danger badge-risk">RED</span>`;
            if (lv === "YELLOW") return `<span class="badge bg-warning text-dark badge-risk">YELLOW</span>`;
            return `<span class="badge bg-success badge-risk">GREEN</span>`;
        }

        /* ====== Marker Iconï¼ˆä¾ç‹€æ…‹é¡¯ç¤ºä¸åŒåœ–ç¤ºï¼‰ ====== */
        function deviceIconHTML(p) {
            const risk = (p.risk_level || "GREEN").toUpperCase();
            const isTicket = !!(p.ticket && p.ticket.has_ticket);
            const isOffline = (p.machine_status || "online") === "offline";

            let cls = "device-icon ";
            let main = "âœ“";

            if (risk === "RED") { cls += "device-red"; main = "!"; }
            else if (risk === "YELLOW") { cls += "device-yellow"; main = "â³"; }
            else { cls += "device-green"; main = "âœ“"; }

            if (isOffline) cls += " offline";

            return `
        <div class="${cls}">
          <div class="main">${main}</div>
          ${isTicket ? `<div class="badge-tool">ğŸ”§</div>` : ``}
        </div>
      `;
        }

        function makeDeviceDivIcon(p) {
            return L.divIcon({
                className: "",              // é¿å… Leaflet é è¨­æ¨£å¼å¹²æ“¾
                html: deviceIconHTML(p),
                iconSize: [28, 28],
                iconAnchor: [14, 14],       // ä¸­å¿ƒå°é½Šåº§æ¨™
                popupAnchor: [0, -14]
            });
        }

        // å·¦å´åˆ—è¡¨ï¼šé£²æ°´æ©Ÿæ¸…å–®
        function renderDeviceList(data) {
            $(".list-group").empty();

            if (data.length == 0) {
                $(".list-group").append(`
          <li class="list-group-item">
            <div class="h1 fw-900 text-muted">è©²å€åŸŸç›®å‰æ²’æœ‰è¨­å‚™è³‡æ–™</div>
          </li>
        `);
                return;
            }

            data.forEach((item) => {
                const p = item.properties;
                const id = p.id;

                const ticketText = p.ticket?.has_ticket
                    ? `<div class="h6 fw-900 text-danger mb-0">å ±ä¿®ï¼š${p.ticket.ticket_status}ï¼ˆ${p.ticket.ticket_id}ï¼‰</div>`
                    : `<div class="h6 fw-900 text-muted mb-0">å ±ä¿®ï¼šç„¡</div>`;

                const dueText = (p.overdue_days && p.overdue_days > 0)
                    ? `<div class="h6 fw-900 text-danger">é€¾æœŸï¼š${p.overdue_days} å¤©</div>`
                    : `<div class="h6 fw-900">åˆ°æœŸï¼š${p.next_service_due}ï¼ˆå‰© ${p.days_to_due} å¤©ï¼‰</div>`;

                const strHTML = `
          <li class="list-group-item device-item" data-id="${id}">
            <div class="d-flex justify-content-between align-items-center">
              <div class="h5 fw-900 mb-1">${p.customer_name}</div>
              <div>${riskBadge(p.risk_level)}</div>
            </div>
            <div class="h6 fw-900 mb-1">${p.name}</div>
            <div class="h6 mb-1">åœ°å€ï¼š${p.address}</div>
            <div class="h6 mb-1">è¯çµ¡ï¼š${p.contact_name}ï¼ˆ${p.contact_phone}ï¼‰</div>
            ${dueText}
            ${ticketText}
            <div class="h6 text-muted mb-0">å·¥ç¨‹å¸«ï¼š${p.engineer?.assigned || "æœªæŒ‡æ´¾"}ï½œç‹€æ…‹ï¼š${p.engineer?.visit_status || "-"}</div>
          </li>
        `;
                $(".list-group").append(strHTML);
            });
        }

        // marker + popup
        function renderMarkers(data) {
            if (data.length == 0) return;

            markerMap = {};

            data.forEach((item, idx) => {
                const p = item.properties;
                const id = p.id;

                const lat = item.geometry.coordinates[1];
                const lng = item.geometry.coordinates[0];

                if (idx == 0) {
                    map.panTo([lat, lng]);
                }

                // Popupï¼šç‹€æ…‹æ‘˜è¦
                const ticketBlock = p.ticket?.has_ticket
                    ? `<div class="mt-2 p-2 border rounded">
               <div class="fw-900 text-danger">å ±ä¿®ä¸­ï¼š${p.ticket.ticket_id}</div>
               <div>ç‹€æ…‹ï¼š${p.ticket.ticket_status}ï½œç­‰ç´šï¼š${p.ticket.priority}</div>
               <div>å•é¡Œï¼š${p.ticket.issue}</div>
             </div>`
                    : `<div class="mt-2 text-muted">å ±ä¿®ï¼šç„¡</div>`;

                const filtersText = (p.filters || []).map(f =>
                    `<li>${f.stage}. ${f.name}ï¼ˆ${f.spec}ï¼‰ï½œä¸‹æ¬¡ï¼š${f.next_due}</li>`
                ).join("");

                const popupHTML = `
          <div class="card" style="min-width: 280px;">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="h5 fw-900 mb-0">${p.customer_name}</div>
                ${riskBadge(p.risk_level)}
              </div>
              <div class="fw-900">${p.name}</div>
              <div class="mt-1">åœ°å€ï¼š${p.address}</div>
              <div>è¯çµ¡ï¼š${p.contact_name}ï¼ˆ${p.contact_phone}ï¼‰</div>
              <hr class="my-2" />
              <div class="fw-900">ä¿é¤Š</div>
              <div>ä¸Šæ¬¡ï¼š${p.last_service_date}</div>
              <div>ä¸‹æ¬¡ï¼š${p.next_service_due}ï¼ˆå‰© ${p.days_to_due} å¤©ï¼‰</div>
              ${(p.overdue_days && p.overdue_days > 0) ? `<div class="text-danger fw-900">å·²é€¾æœŸ ${p.overdue_days} å¤©</div>` : ""}
              <div class="mt-2 fw-900">æ¿¾å¿ƒæ¦‚æ³</div>
              <ul class="mb-0">${filtersText}</ul>
              <div class="mt-2 text-muted">å·¥ç¨‹å¸«ï¼š${p.engineer?.assigned || "æœªæŒ‡æ´¾"}ï½œ${p.engineer?.visit_status || "-"}</div>
              ${ticketBlock}
              ${p.note ? `<div class="mt-2 small text-muted">å‚™è¨»ï¼š${p.note}</div>` : ""}
            </div>
          </div>
        `;

                // é—œéµï¼šä¾è¨­å‚™ç‹€æ…‹å¥—ç”¨ä¸åŒ icon
                const marker = L.marker([lat, lng], { icon: makeDeviceDivIcon(p) }).bindPopup(popupHTML);

                markersCluster.addLayer(marker);

                // ç”¨ id å»ºç´¢å¼•ï¼ˆä¸æ€•æ’åº/æœå°‹/åˆ†é ï¼‰
                markerMap[id] = marker;
            });
        }

        // æ¸…é™¤ marker
        function removeMarker() {
            markersCluster.clearLayers();
            markerMap = {};
        }
    </script>
</body>

</html>